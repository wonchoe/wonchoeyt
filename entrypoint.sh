#!/bin/bash
set -e

# –ß—ñ—Ç–∫—ñ —à–ª—è—Ö–∏ –¥–ª—è cookies
HOSTPATH_COOKIES="/app/ytdl-cookies.txt"
TMP_COOKIES="/tmp/ytdl-cookies.txt"

echo "üîç Checking for cookies sources..."

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π /tmp/ytdl-cookies.txt —è–∫—â–æ –≤—ñ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π
if [ -f "$TMP_COOKIES" ]; then
    echo "üóëÔ∏è  Removing old $TMP_COOKIES..."
    rm -f "$TMP_COOKIES"
fi

# –ö–æ–ø—ñ—é—î–º–æ —Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ cookies –∑ /app/ytdl-cookies.txt (hostPath)
if [ -f "$HOSTPATH_COOKIES" ]; then
    echo "üìã Found cookies at $HOSTPATH_COOKIES"
    COOKIE_SIZE=$(stat -f%z "$HOSTPATH_COOKIES" 2>/dev/null || stat -c%s "$HOSTPATH_COOKIES" 2>/dev/null)
    echo "üì¶ Cookie file size: $COOKIE_SIZE bytes"
    
    if [ "$COOKIE_SIZE" -gt 100 ]; then
        echo "‚úÖ Copying and fixing cookies to $TMP_COOKIES..."
        
        # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç
        python3 - <<'EOF'
import re
import sys

def fix_cookies(input_file, output_file):
    """–ö–æ–Ω–≤–µ—Ä—Ç—É—î cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç"""
    
    with open(input_file, 'r') as f:
        content = f.read()
    
    fixed_lines = []
    fixed_lines.append("# Netscape HTTP Cookie File\n")
    fixed_lines.append("# This file was generated by entrypoint.sh\n")
    
    for line in content.split('\n'):
        line = line.strip()
        
        # Skip empty lines and comments
        if not line or line.startswith('#'):
            continue
        
        # –†–æ–∑–±–∏–≤–∞—î–º–æ –ø–æ —Ç–∞–±—É–ª—è—Ü—ñ—ó –∞–±–æ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –ø—Ä–æ–±—ñ–ª–∞—Ö
        parts = re.split(r'\t+|\s{2,}', line)
        
        # –ú—ñ–Ω—ñ–º—É–º 6 –ø–æ–ª—ñ–≤: domain, flag, path, secure, expiration, name
        # Value –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π (–º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º)
        if len(parts) >= 6:
            domain = parts[0]
            flag = parts[1] if parts[1] in ['TRUE', 'FALSE'] else 'TRUE'
            path = parts[2]
            secure = parts[3] if parts[3] in ['TRUE', 'FALSE'] else 'FALSE'
            expiration = parts[4]
            name = parts[5]
            # Value –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ–º (–¥–ª—è —Ç–µ—Å—Ç–æ–≤–∏—Ö cookies)
            if len(parts) > 6:
                value = '\t'.join(parts[6:]) if len(parts) > 7 else parts[6]
            else:
                value = ''  # –ü–æ—Ä–æ–∂–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤–∏—Ö cookies
            
            # –í–∏–¥–∞–ª—è—î–º–æ \n –∑ –∫—ñ–Ω—Ü—è value —è–∫—â–æ —î
            value = value.rstrip('\n')
            
            # –§–æ—Ä–º—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä—è–¥–æ–∫
            fixed_line = f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n"
            fixed_lines.append(fixed_line)
    
    with open(output_file, 'w') as f:
        f.writelines(fixed_lines)
    
    print(f"‚úÖ Fixed {len(fixed_lines) - 2} cookies")

fix_cookies('/app/ytdl-cookies.txt', '/tmp/ytdl-cookies.txt')
EOF
        
        chmod 644 "$TMP_COOKIES"
        echo "‚úÖ Cookies fixed and copied successfully"
    else
        echo "‚ö†Ô∏è  Warning: Cookie file is too small ($COOKIE_SIZE bytes), might be empty"
    fi
else
    echo "‚ö†Ô∏è  Warning: /app/ytdl-cookies.txt not found"
    echo "   Bot will work without cookies - some platforms may have limitations"
    echo "   Ensure /var/www/ytdl-cookies.txt exists on host and is mounted correctly"
fi

# –ü–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω cookies
if [ -f "$TMP_COOKIES" ]; then
    FINAL_SIZE=$(stat -f%z "$TMP_COOKIES" 2>/dev/null || stat -c%s "$TMP_COOKIES" 2>/dev/null)
    COOKIE_COUNT=$(grep -v '^#' "$TMP_COOKIES" | grep -v '^$' | wc -l)
    echo "üìä Final cookies status: $COOKIE_COUNT cookies, $FINAL_SIZE bytes"
else
    echo "‚ùå No cookies available - bot will run with limited functionality"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js –¥–ª—è yt-dlp JavaScript challenges
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    NODE_PATH=$(which node)
    echo "‚úÖ Node.js detected: $NODE_VERSION at $NODE_PATH"
    
    # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å —â–æ Node.js –≤ PATH
    export PATH="/usr/bin:$PATH"
    
    # –¢–µ—Å—Ç JavaScript execution
    if node -e "console.log('JS OK')" &> /dev/null; then
        echo "‚úÖ Node.js JavaScript execution works"
    else
        echo "‚ö†Ô∏è  Node.js found but JS execution failed"
    fi
else
    echo "‚ö†Ô∏è  Warning: Node.js not found - YouTube signature solving may fail"
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å
echo "üöÄ Starting YouTube Downloader Bot..."
exec python app.py
