#!/bin/bash
set -e

# –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ hostPath —Ñ–∞–π–ª —è–∫—â–æ –≤—ñ–Ω —Å–≤—ñ–∂—ñ—à–∏–π
HOSTPATH_COOKIES="/app/cookies.txt"
TMP_COOKIES="/tmp/cookies.txt"

echo "üîç Checking for cookies sources..."

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π /tmp/cookies.txt —è–∫—â–æ –≤—ñ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π
if [ -f "$TMP_COOKIES" ]; then
    echo "üóëÔ∏è  Removing old /tmp/cookies.txt..."
    rm -f "$TMP_COOKIES"
fi

# –ö–æ–ø—ñ—é—î–º–æ —Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ cookies –∑ /app/cookies.txt (hostPath)
if [ -f "$HOSTPATH_COOKIES" ]; then
    echo "üìã Found cookies at $HOSTPATH_COOKIES"
    COOKIE_SIZE=$(stat -f%z "$HOSTPATH_COOKIES" 2>/dev/null || stat -c%s "$HOSTPATH_COOKIES" 2>/dev/null)
    echo "üì¶ Cookie file size: $COOKIE_SIZE bytes"
    
    if [ "$COOKIE_SIZE" -gt 100 ]; then
        echo "‚úÖ Copying and fixing cookies to $TMP_COOKIES..."
        
        # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç
        python3 - <<'EOF'
import re
import sys

def fix_cookies(input_file, output_file):
    """–ö–æ–Ω–≤–µ—Ä—Ç—É—î cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç"""
    
    with open(input_file, 'r') as f:
        content = f.read()
    
    fixed_lines = []
    fixed_lines.append("# Netscape HTTP Cookie File\n")
    fixed_lines.append("# This file was generated by entrypoint.sh\n")
    
    for line in content.split('\n'):
        line = line.strip()
        
        # Skip empty lines and comments
        if not line or line.startswith('#'):
            continue
        
        # –†–æ–∑–±–∏–≤–∞—î–º–æ –ø–æ —Ç–∞–±—É–ª—è—Ü—ñ—ó –∞–±–æ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –ø—Ä–æ–±—ñ–ª–∞—Ö
        parts = re.split(r'\t+|\s{2,}', line)
        
        if len(parts) >= 7:
            domain = parts[0]
            flag = parts[1] if parts[1] in ['TRUE', 'FALSE'] else 'TRUE'
            path = parts[2]
            secure = parts[3] if parts[3] in ['TRUE', 'FALSE'] else 'FALSE'
            expiration = parts[4]
            name = parts[5]
            # Value –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏, —Ç–æ–º—É –±–µ—Ä–µ–º–æ –≤—Å–µ —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            value = '\t'.join(parts[6:]) if len(parts) > 7 else parts[6]
            
            # –í–∏–¥–∞–ª—è—î–º–æ \n –∑ –∫—ñ–Ω—Ü—è value —è–∫—â–æ —î
            value = value.rstrip('\n')
            
            # –§–æ—Ä–º—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä—è–¥–æ–∫
            fixed_line = f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n"
            fixed_lines.append(fixed_line)
    
    with open(output_file, 'w') as f:
        f.writelines(fixed_lines)
    
    print(f"‚úÖ Fixed {len(fixed_lines) - 2} cookies")

fix_cookies('/app/cookies.txt', '/tmp/cookies.txt')
EOF
        
        chmod 644 "$TMP_COOKIES"
        echo "‚úÖ Cookies fixed and copied successfully"
    else
        echo "‚ö†Ô∏è  Warning: Cookie file is too small ($COOKIE_SIZE bytes), might be empty"
    fi
else
    echo "‚ö†Ô∏è  Warning: /app/cookies.txt not found"
    echo "   Bot will work without cookies - some platforms may have limitations"
    echo "   Create /var/www/ytdl-cookies.txt on host to enable cookie support"
fi

# –ü–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω cookies
if [ -f "$TMP_COOKIES" ]; then
    FINAL_SIZE=$(stat -f%z "$TMP_COOKIES" 2>/dev/null || stat -c%s "$TMP_COOKIES" 2>/dev/null)
    COOKIE_COUNT=$(grep -v '^#' "$TMP_COOKIES" | grep -v '^$' | wc -l)
    echo "üìä Final cookies status: $COOKIE_COUNT cookies, $FINAL_SIZE bytes"
else
    echo "‚ùå No cookies available - bot will run with limited functionality"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js –¥–ª—è yt-dlp JavaScript challenges
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    echo "‚úÖ Node.js detected: $NODE_VERSION"
else
    echo "‚ö†Ô∏è  Warning: Node.js not found - YouTube signature solving may fail"
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å
echo "üöÄ Starting YouTube Downloader Bot..."
exec python app.py
